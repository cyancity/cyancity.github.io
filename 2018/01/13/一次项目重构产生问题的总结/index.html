<!DOCTYPE html><html lang="zh_cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="一次项目重构产生问题的总结"><meta name="keywords" content="微信小程序,Websocket,Swoole,Laravel"><meta name="author" content="Chengyang,undefined"><meta name="copyright" content="Chengyang"><title>一次项目重构产生问题的总结 | CyanCity</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#踩坑，记一次前后端通信重构"><span class="toc-number">1.</span> <span class="toc-text">踩坑，记一次前后端通信重构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#候选方案"><span class="toc-number">1.0.1.</span> <span class="toc-text">候选方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重构流程"><span class="toc-number">1.1.</span> <span class="toc-text">重构流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#总结"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Chengyang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">13</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">7</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image: url(true)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">CyanCity</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">一次项目重构产生问题的总结</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-01-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/PHP/">PHP</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="踩坑，记一次前后端通信重构"><a href="#踩坑，记一次前后端通信重构" class="headerlink" title="踩坑，记一次前后端通信重构"></a>踩坑，记一次前后端通信重构</h2><p>​    最近接手了一个小程序的后续开发，该小程序功能亮点是根据gps 定位获取校园内的车辆轨迹，然后呈现给用户，解决用户等车时不知道车辆什么时候会过来的问题。我会继续开发，用户叫车的功能。如果站台内等车的用户超过定值，则会通知后勤发车。</p>
<p>​    生产版本的前后台请求是 <code>ajax轮询</code>，小程序设置定时器，每<code>1500ms</code>请求一次后台，后台接收到请求随后再去请求公交车的数据中心获取信息，再返还给前端。按照这个逻辑，如果此时100个用户在使用，每个用户使用15秒，那么将会产生1000次请求，而后台也会再请求1000次给公交车的数据中心。这样明显浪费了许多资源，并且后续开发叫车服务，需要实时统计当前叫车人数，我决定采用<code>websoket</code>通信，建立服务端和客户端建立长连接，服务端设置<code>timer</code>去获取公交数据，随后通过<code>webscoket</code>群发给客户端。这种逻辑也优雅很多。</p>
<h4 id="候选方案"><a href="#候选方案" class="headerlink" title="候选方案"></a>候选方案</h4><p>服务器后台使用的是 <code>laravel</code>框架，<code>nginx</code>, <code>mysql</code>,<code>php-7.0</code></p>
<ul>
<li>nodejs + redis + socket.io</li>
<li>swoole</li>
<li>workerman</li>
</ul>
<p>看了各种文档介绍和 demo, 最终选择了 <code>swoole</code> 作为<code>websocket</code>服务器来处理和群发请求。加上<code>Laravel</code> 的 <code>artisan</code>命令配合, 操作起来得心应手。</p>
<h3 id="重构流程"><a href="#重构流程" class="headerlink" title="重构流程"></a>重构流程</h3><p><strong>升级 php 版本</strong></p>
<p>我首先把<code>php</code>7.0升级到了 7.1版本, 我在前两天的夜里，登上了生产服务器，把版本给升级了，没有产生大坑. 对原来的项目没有影响。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ add-repository ppa:ondrej/php</span><br><span class="line">$ apt update</span><br><span class="line">$ apt upgrade php</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* apt install php7.1-mbstring</span><br><span class="line">* apt install php7.1-gd</span><br><span class="line">* apt install php7.1-dom</span><br><span class="line">* apt install php7.1-mysql</span><br><span class="line">* 这些事部分需要手动添加的插件，按需使用。</span><br><span class="line">* 我敲了前三行命令，命令行就自动帮我把插件也连带升级了</span><br><span class="line">**/</span><br></pre></td></tr></table></figure>
<p>升级完毕后查看应用，发现有部分页面打不开，上服务器开了debug，查看了一下，发现是 <code>storage</code>目录下的部分文件没有访问权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd /path/to/project</span><br><span class="line">$ ls -al // 查看项目文件所属用户和用户组，我这里的是 www-data</span><br><span class="line">$ sudo chown -R www-data:www-data ./storage</span><br><span class="line">// 更改了文件的权限即可</span><br></pre></td></tr></table></figure>
<p><strong>安装 swoole</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pecl install swoole</span><br><span class="line">$ php -i | grep &quot;php.ini&quot; // 查看php配置文件位置，添加swoole 插件</span><br><span class="line"></span><br><span class="line">$ echo extension=swoole.so &gt; /path/to/php.ini // 添加扩展</span><br><span class="line">or</span><br><span class="line">$ sudo vim /path/to/php.ini // 添加一行 extension=swoole.so 即可</span><br></pre></td></tr></table></figure>
<p><strong>配置 Laravel，添加自定义类和 artisan 命令</strong></p>
<p>首先新建一个 <code>artisan</code>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /path/to/project</span><br><span class="line">$ php artisan make:command SwooleCommand</span><br></pre></td></tr></table></figure>
<p><code>artisan</code>命令部分代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">namespace App\Console\Commands;</span><br><span class="line">...</span><br><span class="line">class SwooleCommand extends Command</span><br><span class="line">&#123;</span><br><span class="line">    protected $signature = &apos;server:swoole &#123;action&#125;&apos;;</span><br><span class="line">	...</span><br><span class="line">    public function handle()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;argument(&apos;action&apos;) == &apos;start&apos;) &#123;</span><br><span class="line">            $this-&gt;info(&apos;Swoole Server Started!&apos;);</span><br><span class="line">            $this-&gt;start();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;info(&apos;Error Parameter&apos;);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function start()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;server = new \swoole_websocket_server(&quot;0.0.0.0&quot;, 1024);</span><br><span class="line">        $handler = \App::make(&quot;App\Handlers\MapHandler&quot;); // 自定义类用于处理服务器回调</span><br><span class="line">        $this-&gt;server-&gt;on(&quot;Open&quot;, array($handler, &apos;onOpen&apos;));</span><br><span class="line">        $this-&gt;server-&gt;on(&quot;Close&quot;, array($handler, &apos;onClose&apos;));</span><br><span class="line">        $this-&gt;server-&gt;on(&quot;Message&quot;, array($handler, &apos;onMessage&apos;));</span><br><span class="line">        $this-&gt;server-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>添加自定义类</strong></p>
<p>我在 <code>app</code>目录下新建了 <code>Handlers</code>文件夹，并配置了 <code>composer.json</code>处理自定义类的自动加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ vim composer.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  &quot;autoload&quot;: &#123;</span><br><span class="line">    &quot;classmap&quot;: [</span><br><span class="line">      &quot;database&quot;,</span><br><span class="line">      &quot;app/Handlers&quot; // 添加自定义类的路径</span><br><span class="line">    ]</span><br><span class="line">   ...</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>处理回调函数</strong></p>
<p>我在配置 <code>artisan</code>命令的时候，有这样一行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$handler = \App::make(&quot;App\Handlers\MapHandler&quot;); // 自定义类用于处理服务器回调</span><br></pre></td></tr></table></figure>
<p>这是通过 <code>laravel</code>的服务容器新建的类，通过这一行命令，可以让 <code>MapHandler</code>使用<code>laravel</code>框架的所有功能，不用去配置其他的，仅一行代码即可</p>
<p>这是我的<code>MapHandler</code>这些回调函数的写法，都是参照了<code>swoole</code>的官方文档，你完全可以把<code>handler</code>当作一个<code>controller</code>，在这里使用<code>Model</code>,<code>Repository</code>以及各种类库，来处理你自己的业务逻辑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// MapHandler</span><br><span class="line">namespace App\Handlers;</span><br><span class="line">use \swoole_websocket_server;</span><br><span class="line"></span><br><span class="line">public function __construct()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">public function onOpen(swoole_websocket_server $server, $request)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">public function onMessage(swoole_websocket_server $server, $frame)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">public function ($server, $fd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>swoole</code>的<code>onMessage</code>回调中<code>$fd</code>为已连接的客户端编号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 向指定的连接的客户端发送通知。</span><br><span class="line">$server-&gt;push($fd, data)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// $server-&gt;connections 遍历所有websocket连接用户的fd，给所有用户推送</span><br><span class="line">foreach ($server-&gt;connections as $fd) &#123;</span><br><span class="line">	$this-&gt;server-&gt;push($fd, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>有一点要注意的是，推送的<code>$data</code>，只能以<code>string</code>形式传输，原先服务器都是直接返回<code>json</code>格式的数据。</p>
<p>但是你可以使用<code>PHP</code>原生的<code>serialize()</code>方法序列化数据。客户端收到数据的时候反序列化即可</p>
<p>在这里推荐一个 js库，在客户端解析数据</p>
<p><a href="https://github.com/naholyr/js-php-unserialize" target="_blank" rel="noopener">https://github.com/naholyr/js-php-unserialize</a></p>
<p>我昨晚把 <code>websocket</code>服务器配置好之后，以为万事大吉了，结果测试小程序的时候我<code>log</code>出来的数据是对的，但是运行的时候就是没法用，没报错，但是地图上的标记信息显示不出来。之前总是笨笨的使用<code>console.log</code>，后来嫌麻烦，测试时添加一个<code>var log = console.log.bind(console)</code>方法，使用的时候直接<code>log(target)</code>即可。但是这样还是不优雅，一方面是只能显示出特定变量的值，但是无法查看函数的运行轨迹和运行时每个阶段的值。</p>
<p>一筹莫展找不到出错的地方时，突然想到了断点调试。以前总是嫌断点麻烦，其实是懒得去学，其实并不难。只是有的时候人有惰性，有<code>log</code>就挺好，杀鸡焉用牛刀？项目简单的时候，<code>log</code>一下确实简单，但是当项目复杂起来，逻辑和函数嵌套的时候，就需要更优雅更高效的调试方法。</p>
<p>打了断点之后，发现原本用来绑定<code>wxml</code>页面的变量值，通过函数处理，并没有新增从服务器获取的数据，我一直以为是<code>unserialize</code>的库出现了问题，但是也没报错，数据比对之后也没有问题。因为前端的 js 代码并不是我写的，所以又要从头开始梳理代码逻辑，打开<code>git</code>一段一段的比对差异，寻找逻辑。最终锁定了处理服务器数据的那段代码。我把原先删掉的<code>ajax</code>轮询代码又放了上去，发现获取的数据是一个数组，数组中有包含了对象，而经过<code>unserialize</code>处理的数据返回的是一个对象。</p>
<p>问题找到了，其实就是一个数组转对象的问题嘛，这还不简单，我根本没思考，写下了这段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let arr = Array.prototype.slice.call(data)</span><br></pre></td></tr></table></figure>
<p>然后又重新跑了一遍</p>
<p>…</p>
<p>…</p>
<p>还是不行。上网查阅了一下。发现是自己记错了。</p>
<p>上面的那行代码，是用来处理类数组对象的, 常见的为<code>arguments</code></p>
<p>但是对象转数组就不是这样了。谷歌了一下，找到了解决办法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// obj 为要转换的对象，arr 为新生成的数组</span><br><span class="line">let arr = Object.keys(obj).map(key =&gt; obj[key])</span><br></pre></td></tr></table></figure>
<p>Over !</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>这个项目还没做完，目前只是把之前的代码重构了，新功能还在开发中。不过错误和失败都是走向成功的阶梯，每一个用心解决的问题，都是一个宝贵的经验。可以不断加深自己的代码功底和对编程的理解。解决数组序列化的问题，我前后花了两个小时，解决断点纠错和对象转数组，前后花了5个小时。其实在经验丰富的开发者来看，都不是大问题。但是自己对<code>PHP</code>和<code>JavaScript</code>还有许多需要学习的地方。有些知识点当时用不到，就没看，有的知识点虽然看过了，但是实际遇到问题还是不会。都需要摸索和钻研，在这里和各位阅读的开发者共勉。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Chengyang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cyancity.github.io/2018/01/13/一次项目重构产生问题的总结/">http://cyancity.github.io/2018/01/13/一次项目重构产生问题的总结/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/微信小程序/">微信小程序</a><a class="post-meta__tags" href="/tags/Websocket/">Websocket</a><a class="post-meta__tags" href="/tags/Swoole/">Swoole</a><a class="post-meta__tags" href="/tags/Laravel/">Laravel</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/08/春招实习总结/"><i class="fa fa-chevron-left">  </i><span>春招实习总结</span></a></div><div class="next-post pull-right"><a href="/2018/01/11/免密码操作 Git 仓库/"><span>免密码操作 Git 仓库</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2018 By Chengyang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>